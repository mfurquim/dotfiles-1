#!/bin/sh

pgrep emacs >/dev/null || exit 1

trim=false

if [ "$1" = "-r" ]; then
   trim=true
   shift
fi

eclient="emacsclient"

# windows
if [ ! -z "$(uname | awk '$1 ~ /MINGW|MSYS/ {print $1}')" ]; then
    eclient="${eclient}w --server-file $HOME/.emacs.d/server/${EMACS_SERVER_FILE:-emacs-server-file}"
fi

# todo: if a script make timeout bigger than one
emacs_timeout=
if type timeout >/dev/null; then
    emacs_timeout="timeout ${elisp_timeout:-1}"
fi

if [ -f "$1" ]; then
    filename=$1
    shift
    args=
    for a in "$@"; do
	args="${args} \"${a}\""
    done

    # echo "(ns/eval-file \"${filename}\" ${args})"
    trim=true
    result=$($emacs_timeout $eclient --eval "(ns/eval-file \"${filename}\" ${args})")
else
    result=$($emacs_timeout $eclient --eval "(progn $@)")
fi

if [ $? -eq 1 ]; then
    # we could not reach emacs.
    exit 1
fi

if [ "$result" = "nil" ] || [ -z "$result" ]; then
  exit 1
else
    if $trim; then
	# trim a list, or quotes (surrounding characters).
	echo "$result" | \
	    sed -e 's/^(//' \
		-e 's/^"//' \
		-e 's/"$//' \
		-e 's/)$//'
    else
	echo "$result"
    fi
    exit 0
fi
